name: TestingInConda

on:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'
jobs:
  setup-build:
    name: Ex1 (${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest"]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Miniconda with Mamba
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        conda-channels: conda-forge
        python-version: ${{ matrix.python-version }}
        miniforge-version: latest
        use-mamba: true

    - name: Get conda package list
      id: conda-packages
      shell: bash
      run: |
        # Extract package list from environment.yml, excluding python version
        PACKAGES=$(grep -v "^name:" environment.yml | grep -v "^channels:" | grep -v "^dependencies:" | grep -v "^\s*- pip:" | grep -v "^\s*python" | grep "^\s*-" | sed 's/^\s*- //' | tr '\n' ' ')
        echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
    
    - name: Cache Conda Environment
      uses: actions/cache@v3
      with:
        path: ~/conda_pkgs_dir
        key: conda-pkgs-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('environment.yml') }}
        restore-keys: |
          conda-pkgs-${{ runner.os }}-py${{ matrix.python-version }}-
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install Env
      shell: bash
      run: |
        python --version
        # Create environment with matrix Python version
        mamba create -n mtpy-v2-test python=${{ matrix.python-version }} ${{ steps.conda-packages.outputs.packages }} -y
        source ~/.profile
        conda init --all
        conda activate mtpy-v2-test
        python --version  # Verify correct Python version
        uv pip install git+https://github.com/simpeg/pydiso.git
        uv pip install git+https://github.com/kujaku11/mt_metadata.git@pydantic
        uv pip install git+https://github.com/kujaku11/mth5.git@old_pydantic
        uv pip install git+https://github.com/simpeg/aurora@pydantic
        
    - name: Install Our Package
      shell: bash
      run: |
        source ~/.profile
        conda init --all
        conda activate mtpy-v2-test
        uv pip install -e .[test]
        conda list
    - name: Run Tests
      shell: bash
      run: |
        source ~/.profile
        conda init --all
        conda activate mtpy-v2-test
        pytest --cov=./ --cov-report=xml --cov=mtpy -n auto
        
    - name: "Upload coverage to Codecov"
      uses: codecov/codecov-action@v3
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      with:
        fail_ci_if_error: false
        verbose: true
        flags: tests
        
